# 任务管理

> 本文介绍如何通过 Web UI 创建、执行和监控 Agent 任务。

## 任务看板

任务看板是系统的主页面，以 Kanban 形式展示所有任务。

### 四列布局

| 列名 | 说明 | 颜色 |
|------|------|------|
| **待处理** | 新创建的任务，等待执行 | 灰色 |
| **运行中** | 正在执行的任务 | 蓝色 |
| **已完成** | 执行成功的任务 | 绿色 |
| **失败** | 执行失败的任务 | 红色 |

### 操作说明

- **查看详情**：点击任务卡片，右侧面板会展示详情
- **新建任务**：点击右上角「新建任务」按钮
- **刷新**：系统每 5 秒自动刷新，也可手动点击刷新按钮
- **移动端**：通过顶部 Tab 筛选不同状态的任务

## 创建任务

### 操作步骤

1. 在任务看板页面，点击 **「新建任务」** 按钮
2. 弹出创建任务对话框
3. 填写以下字段：

| 字段 | 必填 | 说明 |
|------|------|------|
| **任务名称** | 是 | 任务的简短描述，如 "修复登录 bug" |
| **Agent 类型** | 是 | 选择 AI Agent 类型（下拉选择） |
| **选择实例** | 是 | 选择该类型下运行中的实例 |
| **任务提示词** | 是 | Agent 的执行指令（Prompt） |

4. 点击 **「创建任务」** 按钮

### 注意事项

- 必须有运行中的实例才能创建任务
- 如果没有可用实例，界面会显示提示并引导前往创建
- 切换 Agent 类型时，实例列表会自动过滤

## 执行任务（启动 Run）

### 操作步骤

1. 在看板中点击一个「待处理」状态的任务卡片
2. 在右侧详情面板中，点击 **「启动」** 按钮
3. 系统会创建一个 Run 并加入调度队列
4. 任务状态会变为「运行中」

### 执行流程

```
创建 Run → 加入调度队列 → NodeManager 领取 → 启动容器 → Agent 执行 → 事件上报 → 完成/失败
```

## 查看执行详情

### 实时事件流

点击运行中的任务，详情面板会显示：

- **Agent 输出**：实时滚动的 Agent 事件流
- **事件类型**：消息（message）、工具调用（tool_use）、代码块等
- **执行状态**：queued → running → done/failed/cancelled

### 事件类型说明

| 事件类型 | 说明 |
|----------|------|
| `run_started` | Run 开始执行 |
| `message` | Agent 的文本消息 |
| `tool_use_start` | 开始调用工具 |
| `tool_use_end` | 工具调用结束 |
| `run_completed` | 执行成功完成 |
| `run_failed` | 执行失败 |

## 取消执行

1. 点击运行中的任务
2. 在详情面板中点击 **「停止」** 按钮
3. 系统会发送取消请求，任务状态变为 `cancelled`

## 删除任务

1. 在任务卡片上点击 **删除按钮**（垃圾桶图标）
2. 确认删除
3. 任务及其所有 Run 记录将被删除

## 任务详情页

点击任务卡片上的任务名称链接，可进入独立的任务详情页：

- **路径**：`/tasks/detail?id={taskId}`
- **内容**：任务配置、Run 历史记录、事件详情
- **桌面端**：三栏布局（任务信息 | Run 列表 | 事件流）
- **移动端**：可折叠的运行记录和配置面板

## API 参考

| 操作 | 方法 | 路径 |
|------|------|------|
| 列出任务 | GET | `/api/v1/tasks?limit=N&offset=N` |
| 创建任务 | POST | `/api/v1/tasks` |
| 获取任务 | GET | `/api/v1/tasks/{id}` |
| 删除任务 | DELETE | `/api/v1/tasks/{id}` |
| 创建 Run | POST | `/api/v1/tasks/{id}/runs` |
| 列出 Run | GET | `/api/v1/tasks/{id}/runs` |
| 获取 Run | GET | `/api/v1/runs/{id}` |
| 取消 Run | POST | `/api/v1/runs/{id}/cancel` |
| 获取事件 | GET | `/api/v1/runs/{id}/events` |
| WebSocket | GET | `/ws/runs/{id}/events` |
