# ttyd 独立容器镜像
# 
# 用途：提供 Web 终端服务，按需启动
# 通过 docker exec 连接到目标 Agent 容器
#
# 构建: docker build -f Dockerfile.ttyd -t tools/ttyd:latest .
# 运行: docker run -d -p 7681:7681 -v /var/run/docker.sock:/var/run/docker.sock tools/ttyd:latest

FROM alpine:3.19

# 安装 ttyd 和 docker-cli
RUN apk add --no-cache \
    ttyd \
    docker-cli \
    bash \
    curl

# 创建非 root 用户
RUN adduser -D -s /bin/bash ttyd && \
    addgroup ttyd docker || true

# ttyd 需要访问 docker.sock，因此需要 docker 组权限
# 实际运行时需要挂载 /var/run/docker.sock

USER ttyd
WORKDIR /home/ttyd

# 默认端口
EXPOSE 7681

# 健康检查
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:7681/ || exit 1

# 入口点：启动 ttyd 提供 bash shell
# 实际使用时会通过命令参数指定连接目标容器
ENTRYPOINT ["ttyd"]
CMD ["-W", "-p", "7681", "bash"]
