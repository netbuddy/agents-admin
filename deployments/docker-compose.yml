version: "3.9"

# ============================================================
# 应用服务 + 可选数据库（PostgreSQL）
#
# 基础设施服务（MongoDB、Redis、MinIO）已移至 docker-compose.infra.yml，
# 开发环境和生产环境共用同一份基础设施定义，避免重复。
#
# 使用方法：
#   开发基础设施: docker compose -f docker-compose.infra.yml --env-file .env.dev up -d
#   PostgreSQL:   docker compose -f docker-compose.yml --env-file .env.dev --profile postgres up -d
#   全栈:         docker compose -f docker-compose.infra.yml -f docker-compose.yml --env-file .env.dev --profile full up -d
# ============================================================

services:
  # PostgreSQL 数据库 (可选，用于 driver: postgres)
  postgres:
    image: postgres:16-alpine
    container_name: agents-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-agents}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agents_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-agents_admin}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agents} -d ${POSTGRES_DB:-agents_admin}"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles:
      - postgres

  # API Server (Control Plane)
  api-server:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.api
    container_name: agents-api
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_DRIVER: mongodb
      DATABASE_URI: mongodb://${MONGO_ROOT_USERNAME:-agents_admin}:${MONGO_ROOT_PASSWORD:-agents_dev_password}@mongodb:27017
      DATABASE_NAME: ${MONGO_DB_NAME:-agents_admin}
      REDIS_URL: redis://:${REDIS_PASSWORD:-agents_dev_password}@redis:6379/0
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin_dev_123}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
    ports:
      - "${API_SERVER_PORT:-8080}:8080"
    volumes:
      - ../:/app:ro
    profiles:
      - full

  # Executor (节点执行器，本地开发模式)
  executor:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.agent
    container_name: agents-executor
    depends_on:
      - api-server
    environment:
      API_SERVER_URL: http://api-server:8080
      NODE_ID: dev-node-01
      WORKSPACE_DIR: /workspaces
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - workspaces:/workspaces
    profiles:
      - full

  # Qwen-Code Runner 模板容器（用于动态创建账户容器）
  qwencode-runner:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.runner-qwencode
    image: runners/qwencode:latest
    container_name: qwencode-template
    profiles:
      - build-only
    volumes:
      - qwencode_auth:/home/node/.qwen
      - workspaces:/workspace

volumes:
  postgres_data:
  workspaces:
  qwencode_auth:

networks:
  default:
    name: agents-network
