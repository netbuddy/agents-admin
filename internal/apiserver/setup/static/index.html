<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API Server Setup</title>
<style>
:root {
  --primary: #2563eb;
  --primary-hover: #1d4ed8;
  --success: #16a34a;
  --error: #dc2626;
  --warning: #d97706;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-secondary: #64748b;
  --radius: 8px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
}
.container {
  background: var(--card); border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08); max-width: 680px; width: 100%; padding: 32px;
}
h1 { font-size: 24px; margin-bottom: 4px; }
.subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
.steps { display: flex; gap: 6px; margin-bottom: 28px; }
.step-indicator { flex: 1; height: 4px; border-radius: 2px; background: var(--border); transition: background 0.3s; }
.step-indicator.active { background: var(--primary); }
.step-indicator.done { background: var(--success); }
.step-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
.form-group { margin-bottom: 16px; }
.form-row { display: flex; gap: 12px; }
.form-row .form-group { flex: 1; }
label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; color: var(--text-secondary); }
input, select {
  width: 100%; padding: 10px 12px; border: 1px solid var(--border);
  border-radius: var(--radius); font-size: 14px; outline: none; transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
.hint { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
.btn-row { display: flex; gap: 12px; margin-top: 24px; }
button {
  padding: 10px 20px; border-radius: var(--radius); font-size: 14px; font-weight: 500;
  cursor: pointer; border: 1px solid var(--border); background: var(--card); color: var(--text); transition: all 0.2s;
}
button:hover { background: var(--bg); }
button.primary { background: var(--primary); color: white; border-color: var(--primary); }
button.primary:hover { background: var(--primary-hover); }
button.primary:disabled, button.success:disabled { opacity: 0.5; cursor: not-allowed; }
button.success { background: var(--success); color: white; border-color: var(--success); }
.check-result {
  margin-top: 12px; padding: 10px 14px; border-radius: var(--radius);
  font-size: 13px; display: none; white-space: pre-line;
}
.check-result.ok { background: #f0fdf4; border: 1px solid #bbf7d0; color: var(--success); display: block; }
.check-result.fail { background: #fef2f2; border: 1px solid #fecaca; color: var(--error); display: block; }
.check-result.loading { background: #eff6ff; border: 1px solid #bfdbfe; color: var(--primary); display: block; }
.summary-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.summary-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
.summary-table td:first-child { font-weight: 500; color: var(--text-secondary); width: 140px; }
.hidden { display: none !important; }
.lang-switch {
  position: absolute; top: 16px; right: 16px; font-size: 13px;
  cursor: pointer; color: var(--primary); background: none; border: none; padding: 4px 8px;
}
.wrapper { position: relative; }
.section-hint { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
.mode-card {
  border: 2px solid var(--border); border-radius: var(--radius); padding: 16px; cursor: pointer;
  transition: all 0.2s; margin-bottom: 12px;
}
.mode-card:hover { border-color: var(--primary); background: #f0f6ff; }
.mode-card.selected { border-color: var(--primary); background: #eff6ff; }
.mode-card h3 { font-size: 15px; margin-bottom: 4px; }
.mode-card p { font-size: 13px; color: var(--text-secondary); margin: 0; }
.svc-status { display: flex; gap: 8px; align-items: center; font-size: 13px; padding: 4px 0; }
.svc-dot { width: 8px; height: 8px; border-radius: 50%; }
.svc-dot.healthy { background: var(--success); }
.svc-dot.starting { background: var(--warning); animation: pulse 1s infinite; }
.svc-dot.unhealthy { background: var(--error); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.cred-box { background: #f1f5f9; border-radius: var(--radius); padding: 10px 14px; font-family: monospace; font-size: 12px; margin-top: 8px; line-height: 1.6; }
</style>
</head>
<body>
<div class="wrapper">
<button class="lang-switch" onclick="toggleLang()" id="langBtn">中文</button>
<div class="container">
  <h1 id="mainTitle">API Server Setup</h1>
  <p class="subtitle" id="mainSubtitle">Configure infrastructure, database, Redis, TLS and admin account</p>

  <div class="steps" id="stepIndicators">
    <div class="step-indicator" id="si0"></div>
    <div class="step-indicator" id="si1"></div>
    <div class="step-indicator" id="si2"></div>
    <div class="step-indicator" id="si3"></div>
    <div class="step-indicator" id="si4"></div>
    <div class="step-indicator" id="si5"></div>
  </div>

  <!-- Step 0: Infrastructure Mode -->
  <div id="step0">
    <div class="step-title" data-i18n="step0_title">Step 1: Infrastructure</div>
    <div class="section-hint" data-i18n="infra_hint">Choose how to set up MongoDB, Redis, and MinIO.</div>
    <div class="mode-card selected" id="modeQuick" onclick="selectInfraMode('quick')">
      <h3 data-i18n="infra_quick_title">Quick Deploy (Docker Compose)</h3>
      <p data-i18n="infra_quick_desc">Automatically deploy MongoDB, Redis, and MinIO using Docker Compose. Passwords are auto-generated.</p>
    </div>
    <div class="mode-card" id="modeManual" onclick="selectInfraMode('manual')">
      <h3 data-i18n="infra_manual_title">Use Existing Services</h3>
      <p data-i18n="infra_manual_desc">Connect to your own MongoDB, Redis, or use SQLite/PostgreSQL. For managed services or existing infrastructure.</p>
    </div>

    <!-- Quick Deploy Panel -->
    <div id="quickDeployPanel">
      <div class="form-row" style="margin-top:12px">
        <div class="form-group" style="max-width:120px"><label data-i18n="infra_mongo_port">MongoDB Port</label><input type="number" id="infraMongoPort" value="27017"></div>
        <div class="form-group" style="max-width:120px"><label data-i18n="infra_redis_port">Redis Port</label><input type="number" id="infraRedisPort" value="6379"></div>
        <div class="form-group" style="max-width:120px"><label data-i18n="infra_minio_port">MinIO Port</label><input type="number" id="infraMinioPort" value="9000"></div>
      </div>
      <div class="btn-row" style="margin-top:8px">
        <button class="primary" onclick="generateAndDeploy()" id="btnDeploy" data-i18n="infra_deploy">Generate & Deploy</button>
      </div>
      <div id="infraCredentials" class="hidden" style="margin-top:12px">
        <label style="font-weight:600;color:var(--text)" data-i18n="infra_creds">Generated Credentials</label>
        <div class="cred-box" id="credBox"></div>
      </div>
      <div id="infraServices" class="hidden" style="margin-top:12px">
        <label style="font-weight:600;color:var(--text)" data-i18n="infra_status_label">Service Status</label>
        <div id="svcList" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="step0Check" class="check-result"></div>
    <div class="btn-row">
      <div style="flex:1"></div>
      <button class="primary" onclick="finishInfraStep()" id="btnInfraNext" data-i18n="next">Next</button>
    </div>
  </div>

  <!-- Step 1: Database -->
  <div id="step1" class="hidden">
    <div class="step-title" data-i18n="step1_title">Step 2: Database</div>
    <div class="form-group">
      <label data-i18n="db_type">Database Type</label>
      <div style="display:flex;gap:16px;margin-top:4px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;font-weight:400;color:var(--text)">
          <input type="radio" name="dbType" value="mongodb" onchange="onDbTypeChange()" checked> MongoDB
          <span style="font-size:12px;color:var(--text-secondary)" data-i18n="db_mongo_hint">(recommended)</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;font-weight:400;color:var(--text)">
          <input type="radio" name="dbType" value="postgres" onchange="onDbTypeChange()"> PostgreSQL
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;font-weight:400;color:var(--text)">
          <input type="radio" name="dbType" value="sqlite" onchange="onDbTypeChange()"> SQLite
          <span style="font-size:12px;color:var(--text-secondary)" data-i18n="db_sqlite_hint">(lightweight)</span>
        </label>
      </div>
    </div>
    <!-- SQLite fields -->
    <div id="sqliteFields" class="hidden">
      <div class="form-group">
        <label data-i18n="db_sqlite_path">Database File Path</label>
        <input type="text" id="dbPath" value="/var/lib/agents-admin/agents-admin.db">
      </div>
    </div>
    <!-- MongoDB fields -->
    <div id="mongoFields">
      <div class="form-row">
        <div class="form-group"><label data-i18n="db_host">Host</label><input type="text" id="dbHost" value="localhost"></div>
        <div class="form-group" style="max-width:120px"><label data-i18n="db_port">Port</label><input type="number" id="dbPort" value="27017"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label data-i18n="db_user">Username</label><input type="text" id="dbUser" value="agents_admin"></div>
        <div class="form-group"><label data-i18n="db_password">Password</label><input type="password" id="dbPassword"></div>
      </div>
      <div class="form-group"><label data-i18n="db_name">Database Name</label><input type="text" id="dbName" value="agents_admin"></div>
    </div>
    <!-- PostgreSQL fields (reuses same input IDs, shown/hidden by onDbTypeChange) -->
    <div id="step1Check" class="check-result"></div>
    <div class="btn-row">
      <button onclick="goStep(0)" data-i18n="back">Back</button>
      <div style="flex:1"></div>
      <button class="primary" onclick="validateStep(1)" data-i18n="test_next">Test & Next</button>
    </div>
  </div>

  <!-- Step 2: Redis -->
  <div id="step2" class="hidden">
    <div class="step-title" data-i18n="step2_title">Step 3: Redis</div>
    <div class="form-row">
      <div class="form-group"><label data-i18n="redis_host">Host</label><input type="text" id="redisHost" value="localhost"></div>
      <div class="form-group" style="max-width:120px"><label data-i18n="redis_port">Port</label><input type="number" id="redisPort" value="6379"></div>
    </div>
    <div class="form-group"><label data-i18n="redis_password">Password</label><input type="password" id="redisPassword" placeholder=""></div>
    <div id="step2Check" class="check-result"></div>
    <div class="btn-row">
      <button onclick="goStep(1)" data-i18n="back">Back</button>
      <div style="flex:1"></div>
      <button class="primary" onclick="validateStep(2)" data-i18n="test_next">Test & Next</button>
    </div>
  </div>

  <!-- Step 3: TLS -->
  <div id="step3" class="hidden">
    <div class="step-title" data-i18n="step3_title">Step 4: HTTPS / TLS</div>
    <div class="form-group">
      <label data-i18n="tls_mode">TLS Mode</label>
      <select id="tlsMode" onchange="onTlsModeChange()">
        <option value="auto_generate" data-i18n="tls_auto">Auto-generate self-signed certificate (recommended for LAN)</option>
        <option value="acme" data-i18n="tls_acme">Let's Encrypt auto-certificate (for public domain)</option>
        <option value="disabled" data-i18n="tls_disabled">Disable HTTPS (not recommended)</option>
      </select>
    </div>
    <div id="tlsAutoFields">
      <div class="form-group">
        <label data-i18n="tls_hosts">Additional Hosts/IPs <span style="font-weight:400;color:var(--text-secondary)">(optional)</span></label>
        <input type="text" id="tlsHosts" placeholder="e.g. my-server.local,10.0.0.5">
        <div class="hint" data-i18n="tls_hosts_hint">Localhost and all local IPs are automatically included</div>
      </div>
    </div>
    <div id="tlsAcmeFields" class="hidden">
      <div class="form-group"><label data-i18n="tls_acme_domains">Domain(s)</label><input type="text" id="acmeDomains" placeholder="admin.example.com"></div>
      <div class="form-group"><label data-i18n="tls_acme_email">Email</label><input type="email" id="acmeEmail" placeholder="admin@example.com"></div>
    </div>
    <div id="step3Check" class="check-result"></div>
    <div class="btn-row">
      <button onclick="goStep(2)" data-i18n="back">Back</button>
      <div style="flex:1"></div>
      <button class="primary" onclick="validateStep(3)" data-i18n="next">Next</button>
    </div>
  </div>

  <!-- Step 4: Admin Account -->
  <div id="step4" class="hidden">
    <div class="step-title" data-i18n="step4_title">Step 5: Admin Account</div>
    <div class="section-hint" data-i18n="auth_hint">JWT secret will be auto-generated.</div>
    <div class="form-group"><label data-i18n="admin_email">Admin Email</label><input type="email" id="adminEmail" placeholder="admin@your-domain.com"></div>
    <div class="form-group"><label data-i18n="admin_password">Admin Password</label><input type="password" id="adminPassword" placeholder="At least 8 characters"></div>
    <div class="form-group"><label data-i18n="server_port">Server Port</label><input type="text" id="serverPort" value="8080"></div>
    <div id="step4Check" class="check-result"></div>
    <div class="btn-row">
      <button onclick="goStep(3)" data-i18n="back">Back</button>
      <div style="flex:1"></div>
      <button class="primary" onclick="validateStep(4)" data-i18n="test_next">Validate & Next</button>
    </div>
  </div>

  <!-- Step 5: Confirm -->
  <div id="step5" class="hidden">
    <div class="step-title" data-i18n="step5_title">Step 6: Confirm & Apply</div>
    <table class="summary-table" id="summaryTable"></table>
    <div id="initDbSection" class="hidden" style="margin-top:16px;padding:14px;border-radius:var(--radius);background:#fffbeb;border:1px solid #fde68a">
      <div style="font-weight:600;font-size:14px;color:var(--warning);margin-bottom:8px" data-i18n="init_db_title">Database Initialization</div>
      <div style="font-size:13px;color:#92400e;margin-bottom:10px" data-i18n="init_db_warning">Initialize database schema? This will DELETE ALL existing data.</div>
      <div style="display:flex;align-items:center;gap:8px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:400;color:var(--text)">
          <input type="checkbox" id="confirmInitDb"> <span data-i18n="init_db_confirm">I understand, initialize</span>
        </label>
        <button onclick="initDatabase()" id="btnInitDb" style="font-size:13px;padding:6px 14px" data-i18n="init_db_btn">Initialize</button>
      </div>
      <div id="initDbResult" class="check-result" style="margin-top:8px"></div>
    </div>
    <div id="step5Check" class="check-result"></div>
    <div class="btn-row">
      <button onclick="goStep(4)" data-i18n="back">Back</button>
      <div style="flex:1"></div>
      <button class="success" onclick="applyConfig()" id="btnApply" data-i18n="save_start">Save & Start</button>
    </div>
  </div>
</div>
</div>

<script>
const STEPS = 6;
let infraMode = 'quick'; // 'quick' or 'manual'
let infraCreds = null; // stored credentials from generate-infra
let infraHealthy = false;

// ======== i18n ========
const i18n = {
  en: {
    mainTitle: 'API Server Setup',
    mainSubtitle: 'Configure infrastructure, database, Redis, TLS and admin account',
    step0_title: 'Step 1: Infrastructure',
    step1_title: 'Step 2: Database',
    step2_title: 'Step 3: Redis',
    step3_title: 'Step 4: HTTPS / TLS',
    step4_title: 'Step 5: Admin Account',
    step5_title: 'Step 6: Confirm & Apply',
    infra_hint: 'Choose how to set up MongoDB, Redis, and MinIO.',
    infra_quick_title: 'Quick Deploy (Docker Compose)',
    infra_quick_desc: 'Automatically deploy MongoDB, Redis, and MinIO using Docker Compose. Passwords are auto-generated.',
    infra_manual_title: 'Use Existing Services',
    infra_manual_desc: 'Connect to your own MongoDB, Redis, or use SQLite/PostgreSQL.',
    infra_deploy: 'Generate & Deploy',
    infra_deploying: 'Deploying...',
    infra_creds: 'Generated Credentials',
    infra_status_label: 'Service Status',
    infra_mongo_port: 'MongoDB Port', infra_redis_port: 'Redis Port', infra_minio_port: 'MinIO Port',
    db_type: 'Database Type',
    db_mongo_hint: '(recommended)',
    db_sqlite_hint: '(lightweight)',
    db_sqlite_path: 'Database File Path',
    db_host: 'Host', db_port: 'Port', db_user: 'Username', db_password: 'Password', db_name: 'Database Name',
    redis_host: 'Host', redis_port: 'Port', redis_password: 'Password',
    tls_mode: 'TLS Mode',
    tls_auto: 'Auto-generate self-signed certificate (recommended for LAN)',
    tls_acme: "Let's Encrypt auto-certificate (for public domain)",
    tls_disabled: 'Disable HTTPS (not recommended)',
    tls_hosts: 'Additional Hosts/IPs', tls_hosts_hint: 'Localhost and all local IPs are automatically included',
    tls_acme_domains: 'Domain(s)', tls_acme_email: 'Email',
    admin_email: 'Admin Email', admin_password: 'Admin Password',
    auth_hint: 'JWT secret will be auto-generated.',
    server_port: 'Server Port',
    back: 'Back', next: 'Next', test_next: 'Test & Next', save_start: 'Save & Start',
    testing: 'Testing...', saving: 'Saving configuration...',
    s_db: 'Database', s_redis: 'Redis', s_tls: 'TLS', s_admin: 'Admin', s_port: 'Port', s_minio: 'MinIO',
    init_db_title: 'Database Initialization',
    init_db_warning: 'Initialize database schema? This will DELETE ALL existing data.',
    init_db_confirm: 'I understand, initialize',
    init_db_btn: 'Initialize',
    init_db_running: 'Initializing...',
    langBtn: '中文',
  },
  zh: {
    mainTitle: 'API Server 配置向导',
    mainSubtitle: '配置基础设施、数据库、Redis、TLS 和管理员账户',
    step0_title: '第一步：基础设施',
    step1_title: '第二步：数据库',
    step2_title: '第三步：Redis',
    step3_title: '第四步：HTTPS / TLS',
    step4_title: '第五步：管理员账户',
    step5_title: '第六步：确认并应用',
    infra_hint: '选择如何部署 MongoDB、Redis 和 MinIO。',
    infra_quick_title: '一键部署（Docker Compose）',
    infra_quick_desc: '使用 Docker Compose 自动部署 MongoDB、Redis 和 MinIO，密码自动生成。',
    infra_manual_title: '使用已有服务',
    infra_manual_desc: '连接你自己的 MongoDB、Redis，或使用 SQLite/PostgreSQL。适用于托管服务或已有基础设施。',
    infra_deploy: '生成并部署',
    infra_deploying: '正在部署...',
    infra_creds: '生成的凭据',
    infra_status_label: '服务状态',
    infra_mongo_port: 'MongoDB 端口', infra_redis_port: 'Redis 端口', infra_minio_port: 'MinIO 端口',
    db_type: '数据库类型',
    db_mongo_hint: '（推荐）',
    db_sqlite_hint: '（轻量级）',
    db_sqlite_path: '数据库文件路径',
    db_host: '主机', db_port: '端口', db_user: '用户名', db_password: '密码', db_name: '数据库名',
    redis_host: '主机', redis_port: '端口', redis_password: '密码',
    tls_mode: 'TLS 模式',
    tls_auto: '自动生成自签名证书（推荐，局域网使用）',
    tls_acme: "Let's Encrypt 自动证书（公网域名）",
    tls_disabled: '禁用 HTTPS（不推荐）',
    tls_hosts: '额外主机名/IP', tls_hosts_hint: 'localhost 和所有本机 IP 会自动包含',
    tls_acme_domains: '域名', tls_acme_email: '邮箱',
    admin_email: '管理员邮箱', admin_password: '管理员密码',
    auth_hint: 'JWT 密钥将自动生成。',
    server_port: '服务端口',
    back: '上一步', next: '下一步', test_next: '测试并继续', save_start: '保存并启动',
    testing: '正在测试...', saving: '正在保存配置...',
    s_db: '数据库', s_redis: 'Redis', s_tls: 'TLS', s_admin: '管理员', s_port: '端口', s_minio: 'MinIO',
    init_db_title: '数据库初始化',
    init_db_warning: '是否初始化数据库表结构？这将删除所有已有数据。',
    init_db_confirm: '我已了解，执行初始化',
    init_db_btn: '初始化',
    init_db_running: '正在初始化...',
    langBtn: 'English',
  }
};

let lang = (navigator.language || 'en').startsWith('zh') ? 'zh' : 'en';
function t(k) { return i18n[lang][k] || k; }

function applyI18n() {
  document.getElementById('mainTitle').textContent = t('mainTitle');
  document.getElementById('mainSubtitle').textContent = t('mainSubtitle');
  document.getElementById('langBtn').textContent = t('langBtn');
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    if (el.tagName === 'OPTION') el.textContent = t(k);
    else if (el.tagName !== 'INPUT') el.textContent = t(k);
  });
}

function toggleLang() {
  lang = lang === 'en' ? 'zh' : 'en';
  applyI18n();
  if (!document.getElementById('step5').classList.contains('hidden')) buildSummary();
}

// ======== Navigation ========
function goStep(n) {
  for (let i = 0; i < STEPS; i++) {
    document.getElementById('step' + i).classList.toggle('hidden', i !== n);
    const si = document.getElementById('si' + i);
    si.className = 'step-indicator';
    if (i < n) si.classList.add('done');
    if (i === n) si.classList.add('active');
  }
  if (n === 5) buildSummary();
}

function showCheck(step, status, msg) {
  const el = document.getElementById('step' + step + 'Check');
  el.className = 'check-result ' + status;
  el.textContent = msg;
}

// ======== API ========
function getToken() { return new URLSearchParams(window.location.search).get('token') || ''; }

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json', 'Authorization': 'token ' + getToken() } };
  if (body) opts.body = JSON.stringify(body);
  return (await fetch(path, opts)).json();
}

// ======== Infrastructure Mode ========
function selectInfraMode(mode) {
  infraMode = mode;
  document.getElementById('modeQuick').classList.toggle('selected', mode === 'quick');
  document.getElementById('modeManual').classList.toggle('selected', mode === 'manual');
  document.getElementById('quickDeployPanel').classList.toggle('hidden', mode !== 'quick');
}

async function generateAndDeploy() {
  const btn = document.getElementById('btnDeploy');
  btn.disabled = true; btn.textContent = t('infra_deploying');
  showCheck(0, 'loading', t('infra_deploying'));

  try {
    // 1. Generate
    const gen = await api('POST', '/setup/api/generate-infra', {
      mongo_port: parseInt(document.getElementById('infraMongoPort').value) || 27017,
      redis_port: parseInt(document.getElementById('infraRedisPort').value) || 6379,
      minio_api_port: parseInt(document.getElementById('infraMinioPort').value) || 9000,
      minio_console_port: (parseInt(document.getElementById('infraMinioPort').value) || 9000) + 1,
    });
    if (!gen.success) { showCheck(0, 'fail', gen.message); btn.disabled = false; btn.textContent = t('infra_deploy'); return; }
    infraCreds = gen;

    // Show credentials
    document.getElementById('infraCredentials').classList.remove('hidden');
    document.getElementById('credBox').textContent =
      `MongoDB: ${gen.mongo_user} / ${gen.mongo_password}\n` +
      `Redis:   ${gen.redis_password}\n` +
      `MinIO:   ${gen.minio_user} / ${gen.minio_password}`;

    // 2. Deploy
    const dep = await api('POST', '/setup/api/deploy-infra', {});
    if (!dep.success) { showCheck(0, 'fail', dep.message); btn.disabled = false; btn.textContent = t('infra_deploy'); return; }

    // 3. Poll status
    document.getElementById('infraServices').classList.remove('hidden');
    pollInfraStatus();
  } catch (e) {
    showCheck(0, 'fail', 'Error: ' + e.message);
    btn.disabled = false; btn.textContent = t('infra_deploy');
  }
}

let pollTimer = null;
function pollInfraStatus() {
  if (pollTimer) clearTimeout(pollTimer);
  api('GET', '/setup/api/infra-status').then(r => {
    const list = document.getElementById('svcList');
    if (r.services) {
      list.innerHTML = Object.entries(r.services).map(([name, s]) => {
        const cls = s.health === 'healthy' ? 'healthy' : (s.running ? 'starting' : 'unhealthy');
        return `<div class="svc-status"><span class="svc-dot ${cls}"></span>${name}: ${s.health}</div>`;
      }).join('');
    }
    if (r.status === 'healthy') {
      showCheck(0, 'ok', 'All services are healthy!');
      infraHealthy = true;
      document.getElementById('btnDeploy').textContent = '✓ ' + t('infra_deploy');
      // Auto-fill next steps
      if (infraCreds) prefillFromInfra(infraCreds);
    } else if (r.status === 'error') {
      showCheck(0, 'fail', r.message);
      document.getElementById('btnDeploy').disabled = false;
      document.getElementById('btnDeploy').textContent = t('infra_deploy');
    } else {
      showCheck(0, 'loading', 'Starting services...');
      pollTimer = setTimeout(pollInfraStatus, 3000);
    }
  }).catch(() => { pollTimer = setTimeout(pollInfraStatus, 3000); });
}

function prefillFromInfra(creds) {
  // Database
  document.querySelector('input[name="dbType"][value="mongodb"]').checked = true;
  onDbTypeChange();
  document.getElementById('dbHost').value = 'localhost';
  document.getElementById('dbPort').value = creds.mongo_port;
  document.getElementById('dbUser').value = creds.mongo_user;
  document.getElementById('dbPassword').value = creds.mongo_password;
  document.getElementById('dbName').value = 'agents_admin';
  // Redis
  document.getElementById('redisHost').value = 'localhost';
  document.getElementById('redisPort').value = creds.redis_port;
  document.getElementById('redisPassword').value = creds.redis_password;
}

function finishInfraStep() {
  if (infraMode === 'quick' && !infraHealthy && !infraCreds) {
    showCheck(0, 'fail', lang === 'zh' ? '请先点击"生成并部署"' : 'Please click "Generate & Deploy" first');
    return;
  }
  goStep(1);
}

// ======== Database Type ========
function getDbType() { return document.querySelector('input[name="dbType"]:checked').value; }

function onDbTypeChange() {
  const t = getDbType();
  document.getElementById('sqliteFields').classList.toggle('hidden', t !== 'sqlite');
  document.getElementById('mongoFields').classList.toggle('hidden', t === 'sqlite');
  if (t === 'postgres') {
    document.getElementById('dbPort').value = '5432';
    document.getElementById('dbUser').value = 'agents';
  } else if (t === 'mongodb') {
    document.getElementById('dbPort').value = '27017';
    document.getElementById('dbUser').value = 'agents_admin';
  }
}

// ======== Payload ========
function buildPayload() {
  const dbType = getDbType();
  const db = { type: dbType };
  if (dbType === 'sqlite') {
    db.path = document.getElementById('dbPath').value;
  } else {
    db.host = document.getElementById('dbHost').value;
    db.port = parseInt(document.getElementById('dbPort').value) || (dbType === 'mongodb' ? 27017 : 5432);
    db.user = document.getElementById('dbUser').value;
    db.password = document.getElementById('dbPassword').value;
    db.dbname = document.getElementById('dbName').value;
    if (dbType === 'postgres') db.sslmode = 'disable';
  }
  return {
    database: db,
    redis: {
      host: document.getElementById('redisHost').value,
      port: parseInt(document.getElementById('redisPort').value) || 6379,
      password: document.getElementById('redisPassword').value,
    },
    tls: getTlsConfig(),
    auth: {
      admin_email: document.getElementById('adminEmail').value,
      admin_password: document.getElementById('adminPassword').value,
    },
    server: { port: document.getElementById('serverPort').value || '8080' },
  };
}

function getTlsConfig() {
  const mode = document.getElementById('tlsMode').value;
  if (mode === 'disabled') return { enabled: false, mode: 'disabled' };
  const cfg = { enabled: true, mode };
  if (mode === 'auto_generate') cfg.hosts = document.getElementById('tlsHosts').value;
  if (mode === 'acme') {
    cfg.acme_domains = document.getElementById('acmeDomains').value;
    cfg.acme_email = document.getElementById('acmeEmail').value;
  }
  return cfg;
}

function onTlsModeChange() {
  const m = document.getElementById('tlsMode').value;
  document.getElementById('tlsAutoFields').classList.toggle('hidden', m !== 'auto_generate');
  document.getElementById('tlsAcmeFields').classList.toggle('hidden', m !== 'acme');
}

// ======== Validation ========
async function validateStep(step) {
  showCheck(step, 'loading', t('testing'));

  if (step === 3) { // TLS
    const mode = document.getElementById('tlsMode').value;
    if (mode === 'acme' && !document.getElementById('acmeDomains').value) {
      showCheck(3, 'fail', 'Domain is required for ACME'); return;
    }
    showCheck(3, 'ok', 'TLS: ' + mode);
    setTimeout(() => goStep(4), 400);
    return;
  }

  try {
    const result = await api('POST', '/setup/api/validate', buildPayload());
    const msgs = [];
    let stepOk = true;

    if (step === 1 && result.checks.database) {
      const c = result.checks.database;
      msgs.push(getDbType() + ': ' + (c.ok ? '✓' : '✗') + ' ' + c.message);
      if (!c.ok) stepOk = false;
    }
    if (step === 2 && result.checks.redis) {
      const c = result.checks.redis;
      msgs.push('Redis: ' + (c.ok ? '✓' : '✗') + ' ' + c.message);
      if (!c.ok) stepOk = false;
    }
    if (step === 4 && result.checks.auth) {
      const c = result.checks.auth;
      msgs.push('Auth: ' + (c.ok ? '✓' : '✗') + ' ' + c.message);
      if (!c.ok) stepOk = false;
    }

    showCheck(step, stepOk ? 'ok' : 'fail', msgs.join('\n'));
    if (stepOk) setTimeout(() => goStep(step + 1), 600);
  } catch (e) {
    showCheck(step, 'fail', 'Error: ' + e.message);
  }
}

// ======== Summary ========
function buildSummary() {
  const p = buildPayload();
  const tlsText = p.tls.enabled ? (p.tls.mode === 'acme' ? "Let's Encrypt (" + p.tls.acme_domains + ')' : 'Auto-generate') : 'Disabled';
  let dbText;
  if (p.database.type === 'sqlite') {
    dbText = 'SQLite: ' + (p.database.path || '/var/lib/agents-admin/agents-admin.db');
  } else if (p.database.type === 'mongodb') {
    dbText = 'MongoDB: ' + p.database.user + '@' + p.database.host + ':' + p.database.port + '/' + p.database.dbname;
  } else {
    dbText = 'PostgreSQL: ' + p.database.user + '@' + p.database.host + ':' + p.database.port + '/' + p.database.dbname;
  }
  let redisText = p.redis.host + ':' + p.redis.port;
  if (p.redis.password) redisText += ' (auth)';
  let rows = `
    <tr><td>${t('s_db')}</td><td>${dbText}</td></tr>
    <tr><td>${t('s_redis')}</td><td>${redisText}</td></tr>`;
  if (infraCreds) {
    rows += `<tr><td>${t('s_minio')}</td><td>localhost:${infraCreds.minio_api_port} (${infraCreds.minio_user})</td></tr>`;
  }
  rows += `
    <tr><td>${t('s_tls')}</td><td>${tlsText}</td></tr>
    <tr><td>${t('s_admin')}</td><td>${p.auth.admin_email}</td></tr>
    <tr><td>${t('s_port')}</td><td>${p.server.port}</td></tr>`;
  document.getElementById('summaryTable').innerHTML = rows;
  document.getElementById('initDbSection').classList.toggle('hidden', p.database.type !== 'postgres');
}

// ======== Database Init ========
async function initDatabase() {
  const cb = document.getElementById('confirmInitDb');
  if (!cb.checked) { alert(t('init_db_confirm')); return; }
  const el = document.getElementById('initDbResult');
  el.className = 'check-result loading'; el.textContent = t('init_db_running');
  document.getElementById('btnInitDb').disabled = true;
  try {
    const p = buildPayload();
    const result = await api('POST', '/setup/api/init-db', { database: p.database, confirm_destroy: true });
    if (result.success) {
      el.className = 'check-result ok'; el.textContent = '✓ ' + result.message;
    } else {
      el.className = 'check-result fail'; el.textContent = '✗ ' + result.message;
      document.getElementById('btnInitDb').disabled = false;
    }
  } catch (e) {
    el.className = 'check-result fail'; el.textContent = 'Error: ' + e.message;
    document.getElementById('btnInitDb').disabled = false;
  }
}

// ======== Apply ========
async function applyConfig() {
  showCheck(5, 'loading', t('saving'));
  document.getElementById('btnApply').disabled = true;
  try {
    const result = await api('POST', '/setup/api/apply', buildPayload());
    if (result.success) {
      showCheck(5, 'ok', result.message);
    } else {
      showCheck(5, 'fail', result.error || 'Unknown error');
      document.getElementById('btnApply').disabled = false;
    }
  } catch (e) {
    showCheck(5, 'fail', 'Error: ' + e.message);
    document.getElementById('btnApply').disabled = false;
  }
}

// ======== Init ========
document.addEventListener('DOMContentLoaded', () => { applyI18n(); goStep(0); });
</script>
</body>
</html>
